name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Node dependencies
        run: npm ci

      - name: Build frontend assets
        run: npm run build

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass lftp rsync

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -H -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Upload files via LFTP
        run: |
          lftp -e "set sftp:auto-confirm yes; mirror -R -v --exclude .git/ --exclude .github/ --exclude node_modules/ --exclude vendor/ --exclude storage/logs/ --exclude storage/framework/cache/ --exclude storage/framework/sessions/ --exclude storage/framework/views/ . ${{ secrets.APP_PATH }}; quit" -u "${{ secrets.SSH_USERNAME }}","${{ secrets.SSH_PASSWORD }}" sftp://"${{ secrets.SSH_HOST }}:${{ secrets.SSH_PORT }}"

      - name: Deploy on server
        run: |
          sshpass -p "${{ secrets.SSH_PASSWORD }}" ssh -o StrictHostKeyChecking=no -p ${{ secrets.SSH_PORT }} "${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}" <<'EOF'
          cd "${{ secrets.APP_PATH }}"
          
          echo "ðŸ“¦ DÃ©ploiement en cours..."
          
          # Mettre l'application en maintenance
          php artisan down
          
          # VÃ©rifier et exÃ©cuter install.sh si prÃ©sent
          if [ -f install.sh ]; then
            echo "ðŸ”§ ExÃ©cution de install.sh..."
            chmod +x install.sh
            ./install.sh
          fi
          
          # CrÃ©er la base de donnÃ©es SQLite si nÃ©cessaire
          if [ ! -f database/database.sqlite ]; then
            echo "ðŸ’¾ CrÃ©ation de la base de donnÃ©es SQLite..."
            mkdir -p database
            touch database/database.sqlite
          fi
          
          # Installer les dÃ©pendances Composer (production)
          echo "ðŸ“¥ Installation des dÃ©pendances Composer..."
          composer install --no-dev --optimize-autoloader --no-interaction --ignore-platform-reqs
          
          # Effacer les caches et optimiser
          echo "âš¡ Optimisation de Laravel..."
          php artisan cache:clear
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache
          
          # ExÃ©cuter les migrations
          echo "ðŸ—„ï¸ ExÃ©cution des migrations..."
          php artisan migrate --force
          
          # CrÃ©er le lien symbolique storage
          php artisan storage:link
          
          # RedÃ©marrer les queues
          php artisan queue:restart
          
          # Remettre l'application en ligne
          php artisan up
          
          echo "âœ… DÃ©ploiement terminÃ© avec succÃ¨s !"
          EOF
